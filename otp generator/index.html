<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>OTP Generator</title>
    <!-- Bootstrap CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="d-flex justify-content-center align-items-center vh-100 bg-light">

    <div class="w-100" style="max-width:420px;">
        <div class="text-center p-4 border rounded shadow bg-white">
            <h2 class="mb-3 fw-bold text-dark">OTP Generator</h2>

            <div class="mb-3 text-start">
                <label class="form-label">Mobile number</label>
                <input id="mobileInput" class="form-control" type="tel" placeholder="Enter mobile number (digits only)" maxlength="15">
                <div id="mobileHelp" class="form-text">Enter country code if needed, e.g. 919876543210</div>
            </div>

            <div class="d-grid gap-2 mb-2">
                <button id="sendBtn" class="btn btn-primary" onclick="sendOtp()">Send OTP</button>
                <button id="resendBtn" class="btn btn-outline-secondary" onclick="sendOtp()" style="display:none">Resend OTP</button>
            </div>

            <div id="status" class="small text-muted mb-2">No OTP sent yet.</div>

            <div id="otpBox" style="display:none">
                <div class="mb-2">
                    <label class="form-label">Enter OTP</label>
                    <div class="input-group">
                        <input id="otpInput" class="form-control" type="text" maxlength="6" placeholder="6-digit OTP">
                        <button class="btn btn-outline-secondary" onclick="copyOtp()">Copy</button>
                    </div>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <div><button class="btn btn-success" onclick="verifyOtp()">Verify</button></div>
                    <div id="countdown" class="text-muted small">--</div>
                </div>
                <div id="result" class="mt-2"></div>
            </div>

        </div>
    </div>

    <script>
        // Simple client-side OTP demo. For production, send OTP from server/SMS provider.
        const OTP_TTL = 60; // seconds

        function generateNumericOTP(length = 6) {
            let otp = '';
            for (let i = 0; i < length; i++) otp += Math.floor(Math.random() * 10);
            return otp;
        }

        function maskNumber(n) {
            const s = n.replace(/\D/g, '');
            if (s.length <= 4) return '****' + s;
            return '****' + s.slice(-4);
        }

        let countdownInterval = null;

        function startTimer(seconds) {
            clearInterval(countdownInterval);
            const el = document.getElementById('countdown');
            let remaining = seconds;
            el.innerText = `Expires in ${remaining}s`;
            countdownInterval = setInterval(() => {
                remaining--;
                if (remaining <= 0) {
                    clearInterval(countdownInterval);
                    el.innerText = 'Expired';
                    document.getElementById('resendBtn').style.display = 'inline-block';
                    document.getElementById('sendBtn').disabled = false;
                    sessionStorage.removeItem('otp');
                } else {
                    el.innerText = `Expires in ${remaining}s`;
                }
            }, 1000);
        }

        async function sendOtp() {
            const raw = document.getElementById('mobileInput').value.trim();
            const digits = raw.replace(/\D/g, '');
            const status = document.getElementById('status');
            const sendBtn = document.getElementById('sendBtn');
            document.getElementById('resendBtn').style.display = 'none';

            if (!/^\d{6,15}$/.test(digits)) {
                status.innerText = 'Enter a valid mobile number (6-15 digits).';
                status.className = 'text-danger small mb-2';
                return;
            }

            sendBtn.disabled = true;
            status.innerText = 'Sending OTP...';

            try {
                const resp = await fetch('http://localhost:3000/send-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mobile: digits })
                });
                const data = await resp.json();
                if (!data.ok) {
                    status.innerText = data.error || 'Failed to send OTP';
                    status.className = 'text-danger small mb-2';
                    sendBtn.disabled = false;
                    return;
                }

                document.getElementById('otpBox').style.display = 'block';
                document.getElementById('result').innerText = '';
                status.innerText = `OTP sent to ${maskNumber(digits)}`;
                status.className = 'text-muted small mb-2';
                document.getElementById('resendBtn').style.display = 'none';
                startTimer(OTP_TTL);

                // If server returned the otp (debug mode), prefill for convenience
                if (data.otp) document.getElementById('otpInput').value = data.otp;
            } catch (err) {
                status.innerText = 'Network error sending OTP';
                status.className = 'text-danger small mb-2';
                sendBtn.disabled = false;
            }
        }

        function verifyOtp() {
            const entered = document.getElementById('otpInput').value.trim();
            const stored = sessionStorage.getItem('otp');
            const expiry = Number(sessionStorage.getItem('otpExpiry') || 0);
            const res = document.getElementById('result');

            if (!stored) {
                res.innerHTML = '<span class="text-danger">No OTP available or it has expired.</span>';
                return;
            }
            if (Date.now() > expiry) {
                res.innerHTML = '<span class="text-danger">OTP expired.</span>';
                sessionStorage.removeItem('otp');
                return;
            }
            if (entered === stored) {
                res.innerHTML = '<span class="text-success">Verified âœ“</span>';
                sessionStorage.removeItem('otp');
                clearInterval(countdownInterval);
                document.getElementById('countdown').innerText = '';
            } else {
                res.innerHTML = '<span class="text-danger">Incorrect OTP.</span>';
            }
        }

        function copyOtp() {
            const val = document.getElementById('otpInput').value;
            if (!val) return;
            navigator.clipboard?.writeText(val).then(() => {
                const r = document.getElementById('result');
                r.innerHTML = '<span class="text-muted">OTP copied to clipboard.</span>';
            }).catch(() => {});
        }
    </script>

</body>

</html>